# Functional Analysis of Metacyc database

_**This demo provides guidance to standard data analysis of MetaCyc pathway data. Humman2 is used to annotate MGS reads with MetaCyc database.**_  

![FlowChart_MetaCyc](./flowcharts/FlowChart_MetaCyc.jpg)

---

_**There are five 8 steps in this tutorial:**_  

- [Pipeline file processing](#pipeline-file-processing)  
- [Data loading](#data-loading)  
- [Data preprocess](#data-preprocess)  
- [Beta diversity](#plot-beta-diversity)  
- [Permanova test](#permanova-test)  
- [Differential analysis](#differential-analysisda)  
- [Bacteria contribution to pathway](#bacteria-contribution-to-differential-pathways)  

---

## Environment setup

_**In this chunk, required packages and functions would be loaded.**_  

```{r load_package,message=FALSE,warning=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)

## Remove all libraries and variables in current environment
rm(list = ls())

## Load packages
library(XMAS)
library(xviz)
library(data.table)
library(plotly)
library(xlsx)
library(magrittr)

## Load functions
source("/share/projects/SOP/Functional_Analysis/Tongbangzhuo/Phase1/Metacyc/RScript/permanova.R")
source("/share/projects/SOP/Functional_Analysis/Tongbangzhuo/Phase1/Metacyc/RScript/pathway2gene.R")
source("/share/projects/SOP/Functional_Analysis/Tongbangzhuo/Phase1/Kegg/Scripts/R/ultility.R")
```

---

## Pipeline file processing

_As described in the introduction chapter, **a cohort containing 8 MGS samples of 4 patients from 2 groups in MAFLD project** would be used as demo data in this tutorial._  

### Merge sample files  

Here we need to merge all data from 8 samples into one profile table with the merge script from Humann2 **in Bash**. But if you have merged the sample data already, please skip this chunk and jump to [Data loading](#data-loading).

```markdown

docker run -i --rm -u $(id -u):$(id -g) -v /share/projects/SOP/Functional_Analysis/Tongbangzhuo/Demodata/:/in harbor.xbiome.com/xbiome/environments/humann2:2.8.1-2b8c5c3 bash -c "merge_metaphlan_tables.py /in/PipelineOutput/*/humann2/*_pathabundance.tsv > /in/Metacyc/merged_metacyc_profile.tsv"

```

### Split strain info

Output profile from Humann2 pipeline contains strain information, we need to split the profile file into two files **in Bash**. But if you have splitted the sample data already, please skip this chunk and jump to [Data loading](#data-loading).

- unstratified profile file
- stratified profile file

```markdown

grep -v "|" /share/projects/SOP/Functional_Analysis/Tongbangzhuo/Demodata/Metacyc/merged_metacyc_profile.tsv > /share/projects/SOP/Functional_Analysis/Tongbangzhuo/Demodata/Metacyc/merged_metacyc_profile_unstratified.tsv

grep -E "\\||pathabundance" /share/projects/SOP/Functional_Analysis/Tongbangzhuo/Demodata/Metacyc/merged_metacyc_profile.tsv > /share/projects/SOP/Functional_Analysis/Tongbangzhuo/Demodata/Metacyc/merged_metacyc_profile_stratified.tsv

```

## Data loading

### Read metadata:  

Read MetaCyc metadata from Demo folder.  

```{r metadata}

metadata <- read.table("/share/projects/SOP/Functional_Analysis/Tongbangzhuo/Demodata/metadata.xls",header = TRUE,stringsAsFactors = FALSE) %>%
  mutate(seqid = SeqID) %>%  # keep seqid in the metadata
  column_to_rownames("SeqID")

dim(metadata)

head(metadata)

```

### Read metaphlan2 profile table:  

Read MetaCyc profile table from Demo folder.  

```{r load_unstratified_pahtwaydata}

pathwaydata <- read_delim("/share/projects/SOP/Functional_Analysis/Tongbangzhuo/Demodata/Metacyc/merged_metacyc_profile_unstratified.tsv", delim = "\t") %>%
  mutate(`ID` = str_split_fixed(`ID`, ":", 2)[,1]) %>%           # do not edit 
  column_to_rownames("ID") %>%                                          # do not edit
  t() %>% as.data.frame() %>%                                                  # do not edit
  rownames_to_column("seq_id") %>%                                             # do not edit
  mutate(seq_id=str_remove_all(seq_id, "_.+")) %>%                             # do not edit 
  filter(seq_id %in% metadata$seqid) %>%                                       # *** only keep samples in metadata, edit if needed ***
  column_to_rownames("seq_id")   %>%                                           # do not edit
  t() %>% as.data.frame() %>%                                                  # do not edit
  rownames_to_column("pathway") %>%                                            # do not edit
  filter(rowSums(.[,-1]) > 0) %>%                                              # do not edit
  column_to_rownames("pathway")                                                # do not edit

dim(pathwaydata)
```

---

## Data preprocess

### Transforming data  

In this chunk, we use TSS (Total sum scaling) to eliminate the influence of sequencing depth on samples.  

```{r TSS of MetaCyc data}

rescaled_pathwaydata <- pathwaydata %>% apply(., 2, function(x) x/sum(x)) %>% as.data.frame()

dim(rescaled_pathwaydata)

```

### Remove unppaed pathways  

**Note: you need to [transform](#transforming-data) your data into relative abundance before running this chunk!!**  

```{r filtering}

rescaled_pathway.clean <- rescaled_pathwaydata %>% 
  rownames_to_column("pathway") %>%
  filter(!pathway %in% c("UNMAPPED","UNINTEGRATED")) %>%
  column_to_rownames("pathway")

dim(rescaled_pathway.clean)
```

### Aggregate low abundance data  

In this chunck, we aggregate low abundance features to one row. **Note: you need to [transform](#transforming-data) and [Remove unppaed pathways](#remove-unppaed-pathways) in your data before running this chunk!!**  

_1e-12 is an empirical threshold fot filtering low abundance feature. According to published paper [Obese Individuals with and without Type 2 Diabetes Show Different Gut Microbial Functional Capacity and Composition](https://doi.org/10.1016/j.chom.2019.07.004)  
pathway with top 50% mean abundance and top 50% variance are left. But in MaAsLin2ï¼Œpathway with abundance less than 10-10 are filtered by default._  

```{r aggregate}

pathway.clean <- aggregate_low_abundance(input_data = rescaled_pathway.clean,
                                                           threshold = 1e-12) ## threshold should be modified based on your on study

dim(pathway.clean)
```

---

## Plot Beta diversity  

In this chunk, we plot PCoA with Bray-Curtis distance as example.  
plot_beta_diversity is a fucntion in XVIZ working on calculating the beta diversity distance and visualzing output. Input of plot_beta_diversity should be a phyloseq object.  

```{r beta_diversity,fig.width=12}

phyloseq(otu_table(pathway.clean, taxa_are_rows = T), sample_data(metadata)) %>%
  plot_beta_diversity(feature = "Group",add_pc1 = TRUE, add_pc2 = TRUE)

```

---

## Permanova test  

run_permanova_betadisp is a function in XMAS working on doing dispersion test and PERMANOVA test.  
The first output is dispersion test and the second output is PERMANOVA test.  

```{r permanova_test}

phyloseq(otu_table(pathway.clean, taxa_are_rows = T), sample_data(metadata)) %>%
  run_permanova_betadisp(vars = "Group")

```

---

## Differential analysis(DA)  

### Filter low prevalence pathway  

In this chunk, we would remove pathways apperaing in less than max(2 , 5% of samples) from data set before doing analysis. **Remember to run [Data preprocess](#data-preprocess) section before running this chunk!**  

```{r filter_prevalance}

pathway.filter <- XMAS::filter_prevalence(otu_table = pathway.clean,
                                    metadata = metadata.clean,
                                    threshold = 0.05,
                                    taxa_are_rows = TRUE)

dim(pathway.clean)
dim(pathway.filter)

```

### LefSE

**Remember to [Filter low prevalence pathway](#filter-low-prevalence-pathway) before running this chunk!**  

```{r lefse}
da_pathway =  phyloseq(otu_table(pathway.filter, taxa_are_rows = T), sample_data(metadata)) %>%
  lefse_mgs(compvar = "Group") %>% 
  .$DA_features


da_pathway$id %<>% str_replace_all("_","-")
```

---

## Bacteria contribution to differential pathways  

Use script from Humann2 to visualize the species contribution to differential MetaCyc pathways.

### Generate input from contribution barplot

```{r bacteria_contribution, fig.width=7,fig.width=7}
options(stringsAsFactors = FALSE)

pathway_stratified <- read_delim("/share/projects/SOP/Functional_Analysis/Tongbangzhuo/Demodata/Metacyc/merged_metacyc_profile_stratified.tsv", delim = "\t") %>%
    column_to_rownames("ID") %>%
    t() %>%
    as.data.frame() %>%
    rownames_to_column("seq_id") %>%
    mutate(seq_id=str_remove_all(seq_id, "_.+")) %>%
    filter(seq_id %in% metadata$seqid) %>%
    column_to_rownames("seq_id") %>% 
    t() %>%
    as.data.frame() %>%
    .[apply(.>0, 1, any),] %>%
  #  .[apply(.>0,1, function(x) sum(x) > 4),] %>%
    rownames_to_column("pathwayID") %>%
    mutate(PathwayID=str_split_fixed(pathwayID,":",2)[,1]) %>%
    mutate(Introduce=str_split_fixed(str_split_fixed(pathwayID,":",2)[,2],"\\|",2)[,1]) %>%
    mutate(Genus=str_split_fixed(str_split_fixed(pathwayID,"\\|",2)[,2], "\\.", 2)[,1]) %>%
    mutate(Species=str_split_fixed(str_split_fixed(pathwayID,"\\|",2)[,2], "\\.", 2)[,2]) %>%
    mutate(Species=str_replace(Species, "s__", ""))

pathway_list <- pathway_stratified %>% as.data.frame() %>%
    dplyr::select(PathwayID, Species) %>%
    filter((!str_detect(PathwayID, "UNINTEGRATED"))  & (PathwayID %in% da_pathway$id) & Species!="") %>%
    pivot_wider(names_from = "Species",values_from = "Species") %>%
    column_to_rownames("PathwayID") %>% .[apply(.,1,function(x) sum(!is.na(x))) >= 2,] %>%
    rownames()

pathway_stratified %>%
    column_to_rownames("pathwayID") %>%
    t() %>%
    as.data.frame() %>%
    rownames_to_column("seqid") %>%
    merge(metadata %>% dplyr::select(c(Group, seqid)), .,  by="seqid") %>%
    filter(seqid %in% metadata$seqid) %>%
    column_to_rownames("seqid") %>%
    t() %>%
    as.data.frame() %>%
    rownames_to_column("pathwayID") %>%
    write.table(.,"/share/projects/SOP/Functional_Analysis/Tongbangzhuo/Demodata/Metacyc/merged_relab_pathabundance_stratified.pcl", row.names = FALSE, quote = FALSE, sep = "\t")

for (i in pathway_list) {
    commond_text <- "/home/tongbangzhuo/Software/miniconda3/bin/python /share/projects/SOP/Functional_Analysis/Tongbangzhuo/Phase1/Metacyc/humann2_barplot.py --input /share/projects/SOP/Functional_Analysis/Tongbangzhuo/Demodata/Metacyc/merged_relab_pathabundance_stratified.pcl --focal-feature ${pathwayID} --focal-metadatum Group --last-metadatum Group -d 8 4 --output /share/projects/SOP/Functional_Analysis/github/Functional_analysis/output/MetaCyc/${pathwayID}.png -e 0.8"
    commond_text <- stringr::str_interp(commond_text, list(pathwayID = i))
    system(commond_text)
}

```

---

### Plot Bacteria contribution

```{r plot_bacteria_contribution}

image_path <- NULL

image_path <- system('ls /share/projects/SOP/Functional_Analysis/github/Functional_analysis/output/MetaCyc/*PWY*png', intern = TRUE) %>% unlist() %>% as.character() %>% as.vector() %>% .[1:5]

## In the graph(s) below, green KO are those KOs enriched in GroupB, red KO are those KOs enriched in GroupA
knitr::include_graphics(image_path)

```

---

## Session info

```{r}
devtools::session_info()
```
