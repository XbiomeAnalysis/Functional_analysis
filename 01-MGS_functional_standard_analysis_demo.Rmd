# Functional Analysis of Metacyc database

This demo provides guidance to standard data analysis of pathway data. Humman2 is used to identify pathways with MetaCyc database.     
There are five 7 steps in standard MGS data anlaysis process:   

- load Humman2 output to Rstudio for analysis  
- remove unintegrated and unmapped pathways from dataset  
- beta diversity   
- Permanova test    
- Prevalance filtering  
- differential analysis  
- bacteria contribution to pathway  
- reaction(enzyme) and gene to pathway  

## Environment setup

```{r load_package,message=FALSE,warning=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE,out.width="100%")

library(XMAS)
library(xviz)
library(data.table)
library(plotly)
library(xlsx)
library(magrittr)

source("/share/projects/SOP/Functional_Analysis/Tongbangzhuo/Phase1/Metacyc/RScript/permanova.R")
source("/share/projects/SOP/Functional_Analysis/Tongbangzhuo/Phase1/Metacyc/RScript/pathway2gene.R")
```

## load data

- **metadata**  

```{r metadata}

metadata <- read.table("/home/xuxiaomin/project/standardized_analytics_workflow_R_function/demo_data/Funtional/metadata.txt",header = TRUE,stringsAsFactors = FALSE) %>%
  mutate(seqid2 = seqid) %>%  # keep seqid in the metadata
  column_to_rownames("seqid2") 

rownames(metadata)

```


- **Humann2**: the unstratified pathway table generated by hummann2 is used for analysis first.  

```{r load_unstratified_pahtwaydata}

pathwaydata <- read_delim("/home/xuxiaomin/project/standardized_analytics_workflow_R_function/demo_data/Funtional/merged_relab_pathabundance_unstratified.tsv", delim = "\t") %>%
  mutate(`# Pathway` = str_split_fixed(`# Pathway`, ":", 2)[,1]) %>%           # do not edit 
  column_to_rownames("# Pathway") %>%                                          # do not edit
  t() %>% as.data.frame() %>%                                                  # do not edit
  rownames_to_column("seq_id") %>%                                             # do not edit
  mutate(seq_id=str_extract(seq_id, "\\d{4}")) %>%                             # do not edit 
  filter(seq_id %in% metadata$seqid) %>%                                       # *** only keep samples in metadata, edit if needed ***
  column_to_rownames("seq_id")   %>%                                           # do not edit
  t() %>% as.data.frame() %>%                                                  # do not edit
  rownames_to_column("pathway") %>%                                            # do not edit
  filter(rowSums(.[,-1]) > 0) %>%                                              # do not edit
  column_to_rownames("pathway")                                                # do not edit

colnames(pathwaydata)

```


## Remove unppaed pathways  

```{r filtering}

pathway.clean = pathwaydata %>% 
  rownames_to_column("pathway") %>%
  filter(!pathway %in% c("UNMAPPED","UNINTEGRATED")) %>%
  column_to_rownames("pathway")

```



## Plot Beta diversity  

In this demo, we plot PCoA with Bray-Curtis distance as example.  

```{r beta_diversity,fig.width=12}

# plot_beta_diversity is a fucntion in XVIZ working on calculating the beta diversity distance and visualzing output  
# input of plot_beta_diversity is a phyloseq object

phyloseq(otu_table(pathway.clean, taxa_are_rows = T), sample_data(metadata)) %>%
  plot_beta_diversity(feature = "Group",add_pc1 = TRUE, add_pc2 = TRUE)

```


## Permanova test  

The first output is dispersion test and the second output is PERMANOVA test.  


```{r permanova_test}

# run_permanova_betadisp is a function in XMAS working on doing dispersion test and PERMANOVA test.  

phyloseq(otu_table(pathway.clean, taxa_are_rows = T), sample_data(metadata)) %>%
  run_permanova_betadisp(vars = "Group")

```


## Differential analysis(DA)  

### Preprocess before DA  

We would remove pathways apperaing in less than max(2 , 5% of samples) from data set before doing analysis.  

```{r filter_prevalance}

pathway.filter <- XMAS::filter_prevalence(otu_table = pathway.clean,
                                    metadata = metadata.clean,
                                    threshold = 0.05,
                                    taxa_are_rows = TRUE)

nrow(pathway.clean)
nrow(pathway.filter)

```

### LefSE 

```{r lefse}
da_pathway =  phyloseq(otu_table(pathway.filter, taxa_are_rows = T), sample_data(metadata)) %>%
  lefse_mgs(compvar = "Group") %>% 
  .$DA_features


da_pathway$id %<>% str_replace_all("_","-")

```

## Bacteria contributing to differential pathways  

```{r bacteria_contribution, fig.width=7,fig.width=7}
options(stringsAsFactors = FALSE)
pathway_stratified <- read_delim("/share/projects/SOP/Functional_Analysis/Tongbangzhuo/Phase1/Metacyc/Demodata/merged_relab_pathabundance_stratified.pcl", delim = "\t") %>%
    column_to_rownames("pathwayID") %>%
    t() %>%
    as.data.frame() %>%
    rownames_to_column("seq_id") %>%
    mutate(seq_id=str_extract(seq_id, "\\d{4}")) %>%
    filter(seq_id %in% metadata$seqid) %>%
    column_to_rownames("seq_id") %>% 
    t() %>%
    as.data.frame() %>%
    .[apply(.>0, 1, any),] %>%
  #  .[apply(.>0,1, function(x) sum(x) > 4),] %>%
    rownames_to_column("pathwayID") %>%
    mutate(PathwayID=str_split_fixed(pathwayID,":",2)[,1]) %>%
    mutate(Introduce=str_split_fixed(str_split_fixed(pathwayID,":",2)[,2],"\\|",2)[,1]) %>%
    mutate(Genus=str_split_fixed(str_split_fixed(pathwayID,"\\|",2)[,2], "\\.", 2)[,1]) %>%
    mutate(Species=str_split_fixed(str_split_fixed(pathwayID,"\\|",2)[,2], "\\.", 2)[,2]) %>%
    mutate(Species=str_replace(Species, "s__", ""))

pathway_list <- pathway_stratified %>% as.data.frame() %>%
    dplyr::select(PathwayID, Species) %>%
    filter((!str_detect(PathwayID, "UNINTEGRATED"))  & (PathwayID %in% da_pathway$id) & Species!="") %>%
    pivot_wider(names_from = "Species",values_from = "Species") %>%
    column_to_rownames("PathwayID") %>% .[apply(.,1,function(x) sum(!is.na(x))) >= 2,] %>%
    rownames()
    

read_delim("/home/xuxiaomin/project/standardized_analytics_workflow_R_function/demo_data/Funtional/merged_relab_pathabundance_stratified.tsv", delim = "\t") %>%
    column_to_rownames("# Pathway") %>%
    t() %>%
    as.data.frame() %>%
    rownames_to_column("seqid") %>%
    mutate(seqid=str_extract(seqid, "\\d{4}")) %>%
    merge(metadata,.,  by="seqid") %>%
    filter(seqid %in% metadata$seqid) %>%
    column_to_rownames("seqid") %>%
    t() %>%
    as.data.frame() %>%
    rownames_to_column("pathwayID") %>%
    write.table(.,"/share/projects/SOP/Functional_Analysis/Tongbangzhuo/Phase1/Metacyc/Demodata/merged_relab_pathabundance_stratified.pcl", row.names = FALSE, quote = FALSE, sep = "\t")

for (i in pathway_list) {
    commond_text <- "python3.5 /Xbiome1/tongbangzhuo/Script/humann2_barplot.py --input /home/xuxiaomin/project/standardized_analytics_workflow_R_function/demo_data/Funtional/merged_relab_pathabundance_stratified.pcl --focal-feature ${pathwayID} --focal-metadatum Group --last-metadatum Group -d 8 4 --output /share/projects/SOP/Functional_Analysis/Tongbangzhuo/Phase1/Metacyc/Demodata/pathway_bacteria/${pathwayID}.png -e 0.8"
    commond_text <- stringr::str_interp(commond_text, list(pathwayID = i))
    #system(commond_text)
}


```

## Plot Bacteria Contribution

```{r plot_bacteria_contribution}

image_path <- NULL
for (image in list.files("/home/xuxiaomin/project/standardized_analytics_workflow_R_function/demo_data/Funtional/pathway_bacteria/")){
    if (str_detect(image,".png$")){
        image_path <- c(image_path, paste0("/home/xuxiaomin/project/standardized_analytics_workflow_R_function/demo_data/Funtional/pathway_bacteria/",image))
    }
}
knitr::include_graphics(image_path)

```


## Gene and Ensyme involed in differential pathways  

### load tables to mapping pathway to gene and enzyme  

```{r load_metacyc_data}

# gene family
my_genefamily = read.table("/home/xuxiaomin/project/standardized_analytics_workflow_R_function/demo_data/Funtional/metacyc_data/all.genefamilies.tsv",sep="\t")
my_genefamily_unstratified = my_genefamily %>% filter(!str_detect(V1,"[|]"))  

metacyc_pwy_name = read_delim("/home/xuxiaomin/project/standardized_analytics_workflow_R_function/demo_data/Funtional/metacyc_data/map_metacyc-pwy_name.txt",delim = "\t",col_names = FALSE)

```


### Mapping pathway to related gene and reaction  

```{r gene_ensyme}

cur_path = 1
append_option = TRUE
da_pathway_gene_full_list = list()


for(i in 1:length(pathway_list)){
  pathway_gene_result = pathway2gene(pathway_list[i]) 
  
  if(is.null(pathway_gene_result)){
    cur_path = cur_path+1
    next()
  }
  
  else{
    pathway_gene_result = pathway_gene_result %>% dplyr::filter(genefamily %in% my_genefamily$V1)
  
  if(cur_path == 1){
    append_option = FALSE
  }
  
  if(cur_path > 1){
     append_option = TRUE
  }
  
  #write.xlsx(pathway_gene_result,"/home/xuxiaomin/project/standardized_analytics_workflow_R_function/demo_data/Funtional/pathway_reaction_gene.xlsx",
  #           row.names = FALSE, col.names = TRUE,sheetName = pathway_list[i],
  #           append = append_option)
  
  da_pathway_gene_full_list[[pathway_list[i]]] = pathway_gene_result
    
  cur_path = cur_path + 1
  }  
  
}


```

Show the result of one of the differential pathways for example:  

```{r pathway_reaction_gene_example}

head(da_pathway_gene_full_list[[1]])

```


## Session Info

```{r}
devtools::session_info()
```

